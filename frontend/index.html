<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Хэрэглэгч бүртгэх</title>
    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/axios@0.2.1/dist/axios.min.js"></script>
  </head>
  <body>
    <div id="app">
      <h1>Хэрэглэгч бүртгэх хэсэг</h1>
      <!-- <h1>{{userInfo.lastName}}</h1> -->

      <div v-if="!image">
        <h2>Та өөрийн иргэний үнэмлэхний зурыг оруулна уу</h2>
        <input type="file" @change="onFileChange" />
      </div>
      <div v-else>
        <img :src="image" />

        <button v-if="!uploadURL" @click="removeImage">Арилгах</button>
        <button v-if="!uploadURL" @click="uploadImage">Зураг илгээх</button>
      </div>

      <div v-if="uploadURL">
        <p class="alert">Зураг амжилттай илгээгдлээ</p>
      </div>
      <div v-if="loading">Таны зургыг боловсруулж байна</div>
      <div v-if="uploadURL">
        <div class="user-form">
          <h3>Иргэний үнэмлэхний мэдээлэл</h3>
          <label>Эцэг/эх-ийн нэр: </label>
          <input
            type="text"
            name="lastName"
            disabled="true"
            :value="userInfo.lastName"
          />

          <label>Өөрийн нэр: </label>
          <input
            type="text"
            name="lastName"
            disabled="true"
            :value="userInfo.firstName"
          />
          <label>Регистрийн дугаар: </label>
          <input
            type="text"
            name="stateRegNumber"
            disabled="true"
            :value="userInfo.stateRegNumber"
          />
          <label>Имэйл хаяг:</label>
          <input
            type="text"
            placeholder="Имэйл хаягаа оруулна уу"
            :value="userInfo.email"
            v-on:change="handleChange"
          />
          <button v-on:click="saveInfo">Бүртгүүлэх</button>
        </div>
      </div>
    </div>

    <script>
      const MAX_IMAGE_SIZE = 1000000;

      /* ENTER YOUR ENDPOINT HERE */

      const API_ENDPOINT =
        "https://31ve1tfo1f.execute-api.ap-northeast-2.amazonaws.com/uploads";
      // const RENDER_API_ENDPOINT =
      // "https://ivgj9uylcb.execute-api.ap-northeast-2.amazonaws.com/development/endpoint";
      const RENDER_API_ENDPOINT = "http://localhost:4000/local/endpoint";

      new Vue({
        el: "#app",
        data: {
          userInfo: {},
          alertMessage: "",
          imageName: "4058330.jpg",
          loading: false,
          image: "",
          uploadURL: "",
        },
        methods: {
          handleChange(e) {
            this.userInfo.email = e.target.value;
          },
          saveInfo: async function () {
            if (this.userInfo.email && this.userInfo.firstName) {
              this.userInfo.avatar = this.imageName;
              const response = await axios.post(
                `${RENDER_API_ENDPOINT}/saveUserInfo`,
                { userInfo: this.userInfo }
              );
            } else {
              alert("Имэйл хаягаа оруулна уу");
            }
          },
          onFileChange(e) {
            let files = e.target.files || e.dataTransfer.files;
            if (!files.length) return;
            this.createImage(files[0]);
          },
          createImage(file) {
            // var image = new Image()
            let reader = new FileReader();
            reader.onload = (e) => {
              if (!e.target.result.includes("data:image/jpeg")) {
                return alert("Wrong file type - JPG only.");
              }
              if (e.target.result.length > MAX_IMAGE_SIZE) {
                return alert("Image is loo large.");
              }
              this.image = e.target.result;
            };
            reader.readAsDataURL(file);
          },
          removeImage: function (e) {
            this.image = "";
          },
          uploadImage: async function (e) {
            // Get the presigned URL
            const response = await axios({
              method: "GET",
              url: API_ENDPOINT,
            });

            let binary = atob(this.image.split(",")[1]);
            let array = [];
            for (var i = 0; i < binary.length; i++) {
              array.push(binary.charCodeAt(i));
            }
            let blobData = new Blob([new Uint8Array(array)], {
              type: "image/jpeg",
            });
            const result = await fetch(response.uploadURL, {
              method: "PUT",
              body: blobData,
            });
            // Final URL for the user doesn't need the query string params
            this.uploadURL = response.uploadURL.split("?")[0];
            this.loading = true;
            this.imageName = response.Key;
            this.textract();
          },
          textract: async function () {
            const response = await axios.post(
              `${RENDER_API_ENDPOINT}/textract`,
              { imageName: this.imageName }
            );

            this.getTextract(response.JobId);
          },
          getTextract: async function (JobId) {
            const response = await axios.post(
              `${RENDER_API_ENDPOINT}/textractGet`,
              { imageName: this.imageName, JobId: JobId }
            );
            this.userInfo = response.userInfo;

            this.loading = false;
          },
        },
      });
    </script>
    <style type="text/css">
      body {
        background: #20262e;
        padding: 20px;
        font-family: sans-serif;
      }
      #app {
        background: #fff;
        border-radius: 4px;
        padding: 20px;
        transition: all 0.2s;
        text-align: center;
      }
      #logo {
        width: 100px;
      }
      h2 {
        font-weight: bold;
        margin-bottom: 15px;
      }
      h1,
      h2 {
        font-weight: normal;
        margin-bottom: 15px;
      }
      a {
        color: #42b983;
      }
      img {
        width: 30%;
        margin: auto;
        display: block;
        margin-bottom: 10px;
      }
      .alert {
        color: red;
      }
    </style>
  </body>
</html>
